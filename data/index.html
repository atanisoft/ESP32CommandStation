<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>ESP32 Command Station</title>
 <link rel="icon" type="image/png" href="/loco-32x32.png" sizes="32x32">
 <link rel="stylesheet" href="jquery.mobile-1.5.0-rc1.min.css">
 <script src="jquery.min.js"></script>
 <script src="jquery.mobile-1.5.0-rc1.min.js"></script>
 <script src="jquery.simple.websocket.min.js"></script>
 <script src="jqClock-lite.min.js"></script>
 <style>
  .s88SensorOn {height:25px; width:40px; background-color:#00FF00; color:#FFFFFF;}
  .s88SensorOff {height:25px; width:40px; background-color:#FF0000; color:#FFFFFF;}
  .clockdate {margin:5px;}
  .clocktime {padding:5px; margin:2px;}
  @media (max-width: 35em) {
   tbody tr td:first-child {border-bottom: 1px solid #cfcfcf;}
   .s88Spacer {display:block;}
   .s88Spacer:after {content:none;}
  }
  tbody tr:nth-child(odd) td, tbody tr:nth-child(odd) th {background-color: #9a9a9a;}
 </style>
</head>
<body>
 <div data-role="page" data-theme="b">
  <div data-role="header">ESP32 Command Station</div>
  <div data-role="tabs" id="tabs">
   <div data-role="navbar">
    <ul>
     <li><a href="#throttlePage" data-icon="ui-icon-home">Throttle</a></li>
     <li><a href="#baseStationPage" data-icon="ui-icon-gear">Command Station</a></li>
    </ul>
   </div>
   <div id="throttlePage">
    <div class="ui-grid-b">
     <div class="ui-block-a"><label for="selected-loco-address">Locomotive:</label><input type="number" readonly="true" id="selected-loco-address" value="0"/></div>
     <div class="ui-block-b"><label for="throttle-direction">Direction:</label><input type="checkbox" id="throttle-direction" data-role="flipswitch" data-off-text="FWD" data-on-text="REV" disabled="disabled"/></div>
     <div class="ui-block-c"><button id="throttle-estop" class="ui-corner-all"><font color="RED">EMERGENCY<br>STOP</font></button></div>
    </div>
    <div class="ui-grid-a">
     <div class="ui-block-a"><label for="throttle-speed">Speed:</label><input type="range" id="throttle-speed" min="0" max="126" value="0" disabled="disabled"/></div>
     <div class="ui-block-b"><button id="throttle-acquire-loco" class="ui-corner-all">Acquire Locomotive</button><button id="throttle-release-loco" class="ui-corner-all" disabled="disabled">Release Locomotive</button></div>
    </div>
    <div class="ui-grid-solo">
     <div class="ui-block-a">Functions:</div>
    </div>
    <div class="ui-grid-d">
     <div class="ui-block-a"><input type="checkbox" id="funct_0" data-role="flipswitch"/></div>
     <div class="ui-block-b"><input type="checkbox" id="funct_1" data-role="flipswitch"/></div>
     <div class="ui-block-c"><input type="checkbox" id="funct_2" data-role="flipswitch"/></div>
     <div class="ui-block-d"><input type="checkbox" id="funct_3" data-role="flipswitch"/></div>
     <div class="ui-block-e"><input type="checkbox" id="funct_4" data-role="flipswitch"/></div>
    </div>
    <div class="ui-grid-d">
     <div class="ui-block-a"></div>
     <div class="ui-block-b"><input type="checkbox" id="funct_5" data-role="flipswitch"/></div>
     <div class="ui-block-c"><input type="checkbox" id="funct_6" data-role="flipswitch"/></div>
     <div class="ui-block-d"><input type="checkbox" id="funct_7" data-role="flipswitch"/></div>
     <div class="ui-block-e"><input type="checkbox" id="funct_8" data-role="flipswitch"/></div>
    </div>
    <div data-role="collapsibleset">
     <div data-role="collapsible">
      <h2>F9-F28</h2>
      <div class="ui-grid-d">
       <div class="ui-block-a"></div>
       <div class="ui-block-b"><input type="checkbox" id="funct_9" data-role="flipswitch"/></div>
       <div class="ui-block-c"><input type="checkbox" id="funct_10" data-role="flipswitch"/></div>
       <div class="ui-block-d"><input type="checkbox" id="funct_11" data-role="flipswitch"/></div>
       <div class="ui-block-e"><input type="checkbox" id="funct_12" data-role="flipswitch"/></div>
      </div>
      <div class="ui-grid-d">
       <div class="ui-block-a"></div>
       <div class="ui-block-b"><input type="checkbox" id="funct_13" data-role="flipswitch"/></div>
       <div class="ui-block-c"><input type="checkbox" id="funct_14" data-role="flipswitch"/></div>
       <div class="ui-block-d"><input type="checkbox" id="funct_15" data-role="flipswitch"/></div>
       <div class="ui-block-e"><input type="checkbox" id="funct_16" data-role="flipswitch"/></div>
      </div>
      <div class="ui-grid-d">
       <div class="ui-block-a"></div>
       <div class="ui-block-b"><input type="checkbox" id="funct_17" data-role="flipswitch"/></div>
       <div class="ui-block-c"><input type="checkbox" id="funct_18" data-role="flipswitch"/></div>
       <div class="ui-block-d"><input type="checkbox" id="funct_19" data-role="flipswitch"/></div>
       <div class="ui-block-e"><input type="checkbox" id="funct_20" data-role="flipswitch"/></div>
      </div>
      <div class="ui-grid-d">
       <div class="ui-block-a"></div>
       <div class="ui-block-b"><input type="checkbox" id="funct_21" data-role="flipswitch"/></div>
       <div class="ui-block-c"><input type="checkbox" id="funct_22" data-role="flipswitch"/></div>
       <div class="ui-block-d"><input type="checkbox" id="funct_23" data-role="flipswitch"/></div>
       <div class="ui-block-e"><input type="checkbox" id="funct_24" data-role="flipswitch"/></div>
      </div>
      <div class="ui-grid-d">
       <div class="ui-block-a"></div>
       <div class="ui-block-b"><input type="checkbox" id="funct_25" data-role="flipswitch"/></div>
       <div class="ui-block-c"><input type="checkbox" id="funct_26" data-role="flipswitch"/></div>
       <div class="ui-block-d"><input type="checkbox" id="funct_27" data-role="flipswitch"/></div>
       <div class="ui-block-e"><input type="checkbox" id="funct_28" data-role="flipswitch"/></div>
      </div>
     </div>
    </div>
   </div>
   <div id="baseStationPage">
    <div data-role="accordion" id="cs-accordion" data-height-style="content" data-icons="" data-collapsible="true">
     <h3>Status</h3>
     <div id="cs-status">
      <div class="ui-grid-solo">
       <div class="ui-block-a">
        <table id="cs-table-power" data-role="table" class="ui-responsive">
         <caption>Power Districts</caption>
         <thead>
          <tr>
           <th>District</th>
           <th>Status</th>
           <th>Utilization (mA)</th>
           <th>Power</th>
          </tr>
         </thead>
         <tbody>
         </tbody>
        </table>
       </div>
      </div>
      <div class="ui-grid-solo">
       <table data-role="table" id="cs-table-locomotives" class="ui-responsive">
        <caption>Active Locomotives</caption>
        <thead>
         <tr>
          <th>Address</th>
          <th>Speed</th>
          <th>Direction</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div>
     </div>
     <h3>Turnouts</h3>
     <div id="cs-turnouts">
      <div class="ui-grid-solo">
       <table id="cs-table-turnouts" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
        <thead>
         <tr>
          <th>Address</th>
          <th>Type</th>
          <th>State</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div>
      <div class="ui-grid-solo">
       <a href='#' id='cs-turnout-create' data-role='button' data-show-label='false' data-icon='ui-icon-plus' title='create' class='ui-button-inline'></a>
       <a href='#' id='cs-turnout-refresh' data-role='button' data-show-label='false' data-icon='ui-icon-refresh' title='refresh' class='ui-button-inline'></a>
      </div>
     </div>
     <h3 id="cs-sensors-h3">Sensors</h3>
     <div id="cs-sensors">
      <div class="ui-grid-solo">
       <table id="cs-table-sensors" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
        <thead>
         <tr>
          <th>ID</th>
          <th>Pin</th>
          <th>Pullup</th>
          <th>State</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div>
      <div class="ui-grid-solo">
       <a href='#' id='cs-sensor-create' data-role='button' data-show-label='false' data-icon='ui-icon-plus' title='create' class='ui-button-inline'></a>
       <a href='#' id='cs-sensor-refresh' data-role='button' data-show-label='false' data-icon='ui-icon-refresh' title='refresh' class='ui-button-inline'></a>
      </div>
     </div>
     <h3 id="cs-sensors-s88-h3">Sensors (S88)</h3>
     <div id="cs-sensors-s88">
      <div class="ui-grid-solo">
       <table id="cs-table-sensors-s88" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
        <thead>
         <tr>
          <th>ID</th>
          <th>Data Pin</th>
          <th>Sensor ID Base</th>
          <th>Sensor Count</th>
          <th>State</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div>
      <div class="ui-grid-solo">
       <a href='#' id='cs-sensor-s88-create' data-role='button' data-show-label='false' data-icon='ui-icon-plus' title='create' class='ui-button-inline'></a>
       <a href='#' id='cs-sensor-s88-refresh' data-role='button' data-show-label='false' data-icon='ui-icon-refresh' title='refresh' class='ui-button-inline'></a>
      </div>
     </div>
     <h3 id="cs-outputs-h3">Outputs</h3>
     <div id="cs-outputs">
      <div class="ui-grid-solo">
       <table id="cs-table-outputs" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
        <thead>
         <tr>
          <th>ID</th>
          <th>Pin</th>
          <th>Flags</th>
          <th>State</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div>
      <div class="ui-grid-solo">
       <a href='#' id='cs-output-create' data-role='button' data-show-label='false' data-icon='ui-icon-plus' title='create' class='ui-button-inline'></a>
       <a href='#' id='cs-output-refresh' data-role='button' data-show-label='false' data-icon='ui-icon-refresh' title='refresh' class='ui-button-inline'></a>
      </div>
     </div>
     <h3>Locomotive Roster</h3>
     <div id="cs-loco-roster">
      <div class="ui-grid-solo">
       <table id="cs-table-loco-roster" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
        <thead>
         <tr>
          <th>Address</th>
          <th>Name</th>
          <th>Actions</th>
         </tr>
        </thead>
        <tbody>
        </tbody>
       </table>
      </div>
      <div class="ui-grid-solo">
       <a href='#' id='cs-loco-create' data-role='button' data-show-label='false' data-icon='ui-icon-plus' title='create' class='ui-button-inline'></a>
       <a href='#' id='cs-loco-refresh' data-role='button' data-show-label='false' data-icon='ui-icon-refresh' title='refresh' class='ui-button-inline'></a>
      </div>
     </div>
     <h3>Programmer</h3>
     <div id="cs-prog">
      <div class="ui-grid-a">
       <div class="ui-block-a"><label for="cs-prog-action">Action:</label></div>
       <div class="ui-block-b"><select id="cs-prog-action"><option value="write">Write</option><option value="read">Read</option><option value="identify">Identify Address</option></select></div>
      </div>
      <div class="ui-grid-a" id="cs-prog-div-target">
       <div class="ui-block-a"><label for="cs-prog-target">Programming Mode:</label></div>
       <div class="ui-block-b"><input type="checkbox" id="cs-prog-target" data-role="flipswitch" data-off-text="PROG" data-on-text="OPS"></div>
      </div>
      <div class="ui-grid-a" id="cs-prog-div-addr">
       <div class="ui-block-a"><label for="cs-prog-addr">DCC Address:</label></div>
       <div class="ui-block-b"><input type="number" pattern="[0-9]*" id="cs-prog-addr" value="1" min="1" max="16384"></div>
      </div>
      <div class="ui-grid-a" id="cs-prog-div-cv">
       <div class="ui-block-a"><label for="cs-prog-cv">CV:</label></div>
       <div class="ui-block-b"><input type="number" pattern="[0-9]*" id="cs-prog-cv" value="1" min="1" max="1024"></div>
      </div>
      <div class="ui-grid-a" id="cs-prog-div-mode">
       <div class="ui-block-a"><label for="cs-prog-mode">Mode:</label></div>
       <div class="ui-block-b"><input type="checkbox" id="cs-prog-mode" data-role="flipswitch" data-off-text="Byte" data-on-text="Bit"></div>
      </div>
      <div class="ui-grid-a" id="cs-prog-div-value">
       <div class="ui-block-a"><label for="cs-prog-cv-value">Value:</label></div>
       <div class="ui-block-b"><input type="number" pattern="[0-9]*" id="cs-prog-cv-value" value="1" min="1" max="255"></div>
      </div>
      <div class="ui-grid-b" id="cs-prog-div-bit">
       <div class="ui-block-a"><label for="cs-prog-cv-bit">Bit:</label></div>
       <div class="ui-block-b"><input type="number" pattern="[0-7]*" id="cs-prog-cv-bit" value="0" min="0" max="7"></div>
       <div class="ui-block-c" id="cs-prog-div-bit-value"><input type="checkbox" id="cs-prog-cv-bit-value" data-role="flipswitch" data-off-text="Off" data-on-text="On"></div>
      </div>
      <div class="ui-grid-a" id="cs-prog-div-create-roster">
       <div class="ui-block-a"><label for="cs-prog-create-roster">Create Roster entry:</label></div>
       <div class="ui-block-b"><input type="checkbox" id="cs-prog-create-roster" data-role="flipswitch" data-off-text="No" data-on-text="Yes"></div>
      </div>
      <div class="ui-grid-solo">
       <div class="ui-block-a"><button id="cs-prog-execute" class="ui-corner-all">Execute</button></div>
      </div>
      <div class="ui-grid-solo">
       <div class="ui-block-a"><textarea id="cs-prog-result"></textarea></div>
      </div>
     </div>
     <h3>Web Update (OTA)</h3>
     <div id="cs-ota">
      <form id="cs-ota-form" data-ajax="false">
       OTA Binary (firmware.bin):<input type="file" name="cs-ota-firmware" value="" />
       <input type="button" id="cs-ota-upload" value="Upload"/>
      </form>
     </div>
     <h3>Configuration</h3>
     <div id="cs-config">
      <div class="ui-grid-solo">
       <div data-role="tabs" id="cs-config-tabs">
        <div data-role="navbar">
         <ul>
          <li><a href="#cs-wifi">WiFi</a></li>
          <li><a href="#cs-lcc">LCC</a></li>
          <li><a href="#cs-cdi-uplink">LCC WiFi Uplink</a></li>
          <li><a href="#cs-cdi-hbridge-ops">OPS H-Bridge Events</a></li>
          <li><a href="#cs-cdi-hbridge-prog">PROG H-Bridge Events</a></li>
         </ul>
        </div>
        <div id="cs-wifi">
         <div class="ui-field-contain">
          <label for="cs-wifi-mode">WiFi Mode:</label>
          <select id="cs-wifi-mode">
           <option value="station">Station Only</option>
           <option value="softap-station">Station and SoftAP</option>
           <option value="softap">SoftAP Only</option>
          </select>
         </div>
         <div class="ui-field-contain" id="cs-wifi-sta-div">
          <label for="cs-wifi-ssid">SSID:</label>
          <input type="text" id="cs-wifi-ssid">
          <div class="ui-field-contain" id="cs-wifi-ip-div">
           <label for="cs-wifi-ip-mode">Station IP Assignment:</label>
           <input type="checkbox" id="cs-wifi-ip-mode" data-role="flipswitch" data-off-text="DHCP" data-on-text="Static">
          </div>
          <div class="ui-field-contain" id="cs-wifi-static-div">
           <label for="cs-wifi-sta-ip">IP:</label>
           <input type="text" id="cs-wifi-sta-ip">
           <label for="cs-wifi-sta-gateway">Gateway IP:</label>
           <input type="text" id="cs-wifi-sta-gateway">
           <label for="cs-wifi-sta-netmask">Subnet Mask:</label>
           <input type="text" id="cs-wifi-sta-netmask" value="255.255.255.0">
           <label for="cs-wifi-dns">DNS:</label>
           <input id="cs-wifi-dns" type="text" value="8.8.8.8">
          </div>
         </div>
        </div>
        <div id="cs-lcc">
         <div class="ui-field-contain">
          <label for="cs-lcc-node-id">LCC Node ID (hex):</label>
          <input type="text" id="cs-lcc-node-id">
         </div>
         <div class="ui-field-contain">
          <label for="cs-lcc-can">CAN Interface:</label>
          <input type="checkbox" id="cs-lcc-can" data-role="flipswitch"/>
         </div>
         <div class="ui-field-contain">
          <label for="cs-lcc-hub">WiFi LCC Hub:</label>
          <input type="checkbox" id="cs-lcc-hub" data-role="flipswitch"/>
         </div>
        </div>
        <div id="cs-cdi-uplink">
         <div class="ui-field-contain">
          <label for="cs-lcc-uplink-mode">LCC Uplink Mode:</label>
          <select id="cs-lcc-uplink-mode">
           <option value="0">Auto, Manual</option>
           <option value="1">Manual, Auto</option>
           <option value="2">Auto Only</option>
           <option value="3">Manual Only</option>
          </select>
         </div>
         <div class="ui-field-contain" id="lcc-uplink-auto-div">
          <label for="cs-lcc-uplink-auto-service">mDNS Service Name:</label>
          <input type="text" id="cs-lcc-uplink-auto-service">
         </div>
         <div class="ui-field-contain" id="lcc-uplink-manual-div">
          <label for="cs-lcc-uplink-manual-host">LCC Uplink manual host:</label>
          <input type="text" id="cs-lcc-uplink-manual-host">
          <label for="cs-lcc-uplink-manual-port">LCC Uplink manual port:</label>
          <input type="number" id="cs-lcc-uplink-manual-port">
         </div>
         <div class="ui-field-contain">
          <label for="cs-lcc-uplink-reconnect">Uplink reconnect:</label>
          <input type="checkbox" id="cs-lcc-uplink-reconnect" data-role="flipswitch"/>
         </div>
        </div>
        <div id="cs-cdi-hbridge-ops">
         <div class="ui-field-contain">
          <label for="cs-cdi-ops-short">Short (hex):</label>
          <input type="text" id="cs-cdi-ops-short">
          <label for="cs-cdi-ops-short-clear">Short Cleared (hex):</label>
          <input type="text" id="cs-cdi-ops-short-clear">
          <label for="cs-cdi-ops-shutdown">Shutdown (hex):</label>
          <input type="text" id="cs-cdi-ops-shutdown">
          <label for="cs-cdi-ops-shutdown-clear">Shutdown Cleared (hex):</label>
          <input type="text" id="cs-cdi-ops-shutdown-clear">
         </div>
        </div>
        <div id="cs-cdi-hbridge-prog">
         <div class="ui-field-contain">
          <label for="cs-cdi-prog-short">Short (hex):</label>
          <input type="text" id="cs-cdi-prog-short">
          <label for="cs-cdi-prog-short-clear">Short Cleared (hex):</label>
          <input type="text" id="cs-cdi-prog-short-clear">
          <label for="cs-cdi-prog-shutdown">Shutdown (hex):</label>
          <input type="text" id="cs-cdi-prog-shutdown">
          <label for="cs-cdi-prog-shutdown-clear">Shutdown Cleared (hex):</label>
          <input type="text" id="cs-cdi-prog-shutdown-clear">
         </div>
        </div>
       </div>
      </div>
      <div class="ui-grid-solo">
       <input type="button" id="cs-save-config" value="Save" class='ui-button-inline'/>
       <input type="button" id="cs-factory-reset" value="Factory Reset" class='ui-button-inline'/>
       <input type="button" id="cs-wifi-connect" value="Connect to Network" class='ui-button-inline'/>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div data-role="footer"><div id="clock"></div></div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="ssid-connect" class="ui-corner-all">
   <div data-role="header">Available SSIDs</div>
   <div data-role="main" class="ui-content">
    <table id="ssid-list" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
     <thead>
      <tr>
       <th>SSID</th>
       <th>Strength</th>
       <th>Auth?</th>
       <th>Actions</th>
      </tr>
     </thead>
     <tbody>
     </tbody>
    </table>
    <div id="ssid-manual-entry">
     <label for="ssid-manual-ssid">SSID:</label>
     <input type="text" id="ssid-manual-ssid">
     <label for="ssid-manual-password">Password:</label>
     <input type="password" id="ssid-manual-password">
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
    <ul>
      <li><a href="#baseStationPage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li><a href="#" id="ssid-connect-manual" data-icon="ui-icon-plus" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Manual</a></li>
      <li><a href="#" id="ssid-connect-rescan" data-icon="ui-icon-recycle" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Rescan</a></li>
      <li><a href="#baseStationPage" id="ssid-connect-confirm" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
    </ul>
    </div>
   </div>
  </div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="throttle-loco-select" class="ui-corner-all">
   <div data-role="header">Select Locomotive</div>
   <div data-role="main" class="ui-content">
    <table id="throttle-loco-list" data-role="table" class="ui-body-d ui-shadow table-stripe ui-responsive">
     <thead>
      <tr>
       <th>Address</th>
       <th>Type</th>
       <th>Description</th>
      </tr>
     </thead>
     <tbody>
     </tbody>
    </table>
    <div id="throttle-loco-select-manual">
     <label for="">Address:</label>
     <input type="number" pattern="[0-9]*" id="throttle-loco-select-manual-address" value="1" min="1" max="16384">
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
     <ul>
      <li><a href="#throttlePage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li id="throttle-loco-select-add-li"><a href="#" id="throttle-loco-select-add" data-icon="ui-icon-plus" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Manual</a></li>
      <li id="throttle-loco-select-confirm-li"><a href="#throttlePage" id="throttle-loco-select-confirm" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
     </ul>
    </div>
   </div>
  </div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="cs-turnout-editor" class="ui-corner-all">
   <div data-role="header">Turnout Editor</div>
   <div data-role="main" class="ui-content">
    <div class="ui-field-contain">
     <label for="cs-turnout-address">Address:</label>
     <input type="number" pattern="[0-9]*" id="cs-turnout-address" value="1" min="1" max="2044">
    </div>
    <div class="ui-field-contain">
     <label for="cs-turnout-type">Type:</label>
     <select id="cs-turnout-type"><option value="0">Left</option><option value="1">Right</option><option value="2">Wye</option><option value="3">Multi (threeway/etc)</option></select>
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
     <ul>
      <li><a href="#baseStationPage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li><a href="#baseStationPage" id="cs-turnout-dialog-save" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
     </ul>
    </div>
   </div>
  </div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="cs-sensor-editor" class="ui-corner-all">
   <div data-role="header">Sensor Editor</div>
   <div data-role="main" class="ui-content">
    <div class="ui-field-contain">
     <label for="cs-sensor-id">Sensor ID:</label>
     <input type="number" pattern="[0-9]*" id="cs-sensor-id" value="1" min="1" max="32767">
    </div>
    <div class="ui-field-contain">
     <label for="cs-sensor-pin">Pin:</label>
     <input type="number" pattern="[0-9]*" id="cs-sensor-pin" value="1" min="1" max="40">
    </div>
    <div class="ui-field-contain">
     <label for="cs-sensor-pullup">Pull Up:</label>
     <input type="checkbox" id="cs-sensor-pullup" data-role="flipswitch" data-off-text="Off" data-on-text="On" />
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
     <ul>
      <li><a href="#baseStationPage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li><a href="#baseStationPage" id="cs-sensor-dialog-save" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
     </ul>
    </div>
   </div>
  </div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="cs-sensor-s88-editor" class="ui-corner-all">
   <div data-role="header">S88 Sensor Bus Editor</div>
   <div data-role="main" class="ui-content">
    <div class="ui-field-contain">
     <label for="cs-sensor-s88-id">Sensor Bus ID:</label>
     <input type="number" pattern="[0-9]*" id="cs-sensor-s88-id" value="0" min="0" max="10">
    </div>
    <div class="ui-field-contain">
     <label for="cs-sensor-s88-sensor-id">First sensor ID:</label>
     <input type="number" id="cs-sensor-s88-sensor-id" value="512" readonly="true">
    </div>
    <div class="ui-field-contain">
     <label for="cs-sensor-s88-pin">Data Pin:</label>
     <input type="number" pattern="[0-9]*" id="cs-sensor-s88-pin" value="0" min="0" max="40">
    </div>
    <div class="ui-field-contain">
     <label for="cs-sensor-s88-count">Sensor Count:</label>
     <input type="number" pattern="[0-9]*" id="cs-sensor-s88-count" value="8" min="8" max="511">
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
     <ul>
      <li><a href="#baseStationPage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li><a href="#baseStationPage" id="cs-sensor-s88-dialog-save" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
     </ul>
    </div>
   </div>
  </div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="cs-output-editor" class="ui-corner-all">
   <div data-role="header">Output Editor</div>
   <div data-role="main" class="ui-content">
    <div class="ui-field-contain">
     <label for="cs-output-id">ID:</label>
     <input type="number" pattern="[0-9]*" id="cs-output-id" value="1" min="1" max="32767">
    </div>
    <div class="ui-field-contain">
     <label for="cs-output-pin">Pin:</label>
     <input type="number" pattern="[0-9]*" id="cs-output-pin" value="1" min="1" max="40">
    </div>
    <div class="ui-field-contain">
     <label for="cs-output-logic">Logic:</label>
     <input type="checkbox" id="cs-output-logic" data-role="flipswitch" data-off-text="Normal" data-on-text="Inverted" />
    </div>
    <div class="ui-field-contain">
     <label for="cs-output-startup-state">Startup State:</label>
     <input type="checkbox" id="cs-output-startup-state" data-role="flipswitch" data-off-text="Last State" data-on-text="Forced" />
    </div>
    <div class="ui-field-contain" id="cs-output-default-state-div">
     <label for="cs-output-default-state">Default State:</label>
     <input type="checkbox" id="cs-output-default-state" data-role="flipswitch" data-off-text="Off" data-on-text="On" />
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
     <ul>
      <li><a href="#baseStationPage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li><a href="#baseStationPage" id="cs-output-dialog-save" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
     </ul>
    </div>
   </div>
  </div>
  <div data-role="popup" data-close-btn="none" data-dismissible="false" id="cs-loco-editor" class="ui-corner-all">
   <div data-role="header">Locomotive Editor</div>
   <div data-role="main" class="ui-content">
    <div class="ui-field-contain">
     <label for="cs-loco-addr">Address:</label>
     <input type="number" pattern="[0-9]*" id="cs-loco-addr" value="1" min="1" max="16384" />
    </div>
    <div class="ui-field-contain">
     <label for="cs-loco-name">Name:</label>
     <input type="text" id="cs-loco-name" value="" />
    </div>
    <div class="ui-field-contain">
     <label for="cs-loco-idle">Automatically add this locomotive to the "Active Locomotives" list on Command Station startup?</label>
     <input type="checkbox" id="cs-loco-idle" data-role="flipswitch" data-off-text="No" data-on-text="Yes" />
    </div>
    <div class="ui-field-contain">
     <label for="cs-loco-default">Include this locomotive in the Throttle locomotive list?</label>
     <input type="checkbox" id="cs-loco-default" data-role="flipswitch" data-off-text="No" data-on-text="Yes" />
    </div>
   </div>
   <div role="footer">
    <div data-role="navbar">
     <ul>
      <li><a href="#baseStationPage" data-rel="back" data-icon="ui-icon-back" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Cancel</a></li>
      <li><a href="#baseStationPage" id="cs-loco-save" data-icon="ui-icon-check" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-notext">Confirm</a></li>
     </ul>
    </div>
   </div>
  </div>
 </div>
 <script type="text/javascript">
var fireLocoEvents = true;
var firePowerEvents = true;
var online = true;
var webSocket;
var bsTabRefreshInterval = null;
var s88SensorIDBase = 512;
function showSpinner(text, refresh) {
 refresh = typeof refresh !== 'undefined' ? refresh : false;
 setTimeout(function () { $.mobile.loading('show', {text: text,textVisible: true,textonly: false});}, 2);
 if(refresh) {setTimeout(function() {location.reload();}, 25000);}
}
function hideSpinner() {
 setTimeout(function () { $.mobile.loading('hide'); }, 1);
}
function showErrorDialog(text, error) {
  error = typeof error !== 'undefined' ? error : "";
 setTimeout(function() {alert(text);console.log(text, error);}, 500);
}
function connectWebSocket() {
 var socketUrl = $.mobile.path.getDocumentBase().replace("http", "ws");
 if(socketUrl.indexOf('#') > 0) {
  socketUrl = socketUrl.substring(0, socketUrl.lastIndexOf('/') + 1);
 }
 if(socketUrl.endsWith('/index.html') > 0) {
  socketUrl = socketUrl.substring(0, socketUrl.lastIndexOf('/') + 1);
 }
 if(socketUrl.endsWith('/')) {
  socketUrl = socketUrl + 'ws';
 } else {
  socketUrl = socketUrl + '/ws';
 }
 console.log('Websocket url:', socketUrl);
 webSocket = $.simpleWebSocket({url: socketUrl, dataType: 'text'});
 webSocket.listen(function(msg) {
  console.log('WS:', msg);
 });
 webSocket.connect();
}
function sendCommand(cmd) {
 console.log(cmd);
 if(!webSocket) {
  connectWebSocket();
 }
 webSocket.send(cmd);
}
function createButton({type, id, title='',}= {}) {
 if(title === '') {
  if(type === 'delete') {
   title = 'Delete';
  } else if(type === 'edit') {
   title = 'Edit';
  } else if(type === 'stop') {
   title = 'Stop';
  }
 }
 return String.format("<a href='#' data-role='button' data-show-label='false' class='ui-button-inline' data-icon='ui-icon-{0}' data-iconpos='notext' title='{1}' id='{2}'>{1}</a>", type, title, id);
}
$(function() {
 registerStringFormat();
 initPage();
});
function registerStringFormat() {
 if (!String.format) {
  String.format = function(format) {
   var args = Array.prototype.slice.call(arguments, 1);
   return format.replace(/{(\d+)}/g, function(match, number) { 
   return typeof args[number] != 'undefined'
    ? args[number] 
    : match
   ;
   });
  };
 }
}
function initPage() {
 if(!$.mobile.path.getDocumentBase().startsWith("file://")) {
  $.ajax({
   url: '/features',
   beforeSend: function() { showSpinner('Connecting to Command Station...');},
   complete: hideSpinner,
   success : function (data, status, xhr) {
    connectWebSocket();
    if(data.sensors === false) {
     $('[id^=cs-sensors]').hide();
    }
    if(data.outputs === false) {
     $('[id^=cs-outputs]').hide();
    }
    if(data.s88 === false) {
     $('[id^=cs-sensors-s88]').hide();
    } else {
     s88SensorIDBase = data.sensorIDBase;
    }
   }
  });
 } else {
  online=false;
 }
 $('#clock').clock({"timeFormat":"H:i:s"});
 setupThrottle();
 setupBaseStation();
 $.ajaxSetup({timeout:5000});
}
function enableTrackPower() {
 sendCommand('<1>');
}
function setupThrottle() {
 $("#throttle-speed").on("slidestop", function(event, ui) {
  if(fireLocoEvents) {
   var selectedLoco = $("#selected-loco-address").val();
   var speed = $("#throttle-speed").val();
   sendCommand(String.format('<tex {0} {1} -1>', selectedLoco, speed));
  }
 });
 $("#throttle-estop").on("vclick", function(event, ui) {
  $("#throttle-speed").val(0).slider("refresh");
  sendCommand('<estop>');
 });
 $("#throttle-direction").on('change', function(event, ui) {
  if(fireLocoEvents) {
   var selectedLoco = $("#selected-loco-address").val();
   var dir = '1';
   if(this.checked) {
    dir = '0';
   }
   sendCommand(String.format('<tex {0} -1 {1}>', selectedLoco, dir));
  }
 });
 $('#throttle-acquire-loco').on('vclick', function(event, ui) {
  refreshTable({
   table:'#throttle-loco-list',
   url:'/locomotive/roster',
   fields: ['address', 'type', 'description'],
   filter : function(record) {
    return record.defaultOnThrottles === "true";
   },
   failureHandler: function(jqxhr, status, error) {
    console.log('Failed to retrieve locomotive list from command station, switching to manual:', error);
    $("#throttle-loco-list").hide();
    $("#throttle-loco-select-manual").show();
    $("#throttle-loco-select").popup("open");
   },
   refreshCallback: function() {
    $("#throttle-loco-list tr").on("vclick", function(event, ui) {
     changeLocomotive($(event.target).parent().children(":eq(0)").text().substr(7));
     $("#throttle-loco-select").popup("close");
    });
    if($("#throttle-loco-list tr td").children().length == 0) {
      $("#throttle-loco-list").hide();
      $("#throttle-loco-select-add-li").hide();
      $("#throttle-loco-select-manual").show();
      $("#throttle-loco-select-confirm-li").show();
    } else {
      $("#throttle-loco-list").show();
      $("#throttle-loco-select-add-li").show();
      $("#throttle-loco-select-manual").hide();
      $("#throttle-loco-select-confirm-li").hide();
    }
    $("#throttle-loco-select").popup("open");
   }});
 });
 $('#throttle-release-loco').on('vclick', function(event, ui) {
  var selectedLoco = $("#selected-loco-address").val();
  if(selectedLoco > 0) {
   $("#throttle-speed").val(0).slider("refresh");
   $("#throttle-direction").prop('checked', false).flipswitch('refresh');
   $.ajax({url: '/locomotive?address=' + selectedLoco, method: 'DELETE'});
   disableLocomotiveInputs();
  }
 });
 if(online) {
  $("#throttle-loco-select-manual").hide();
  $("#throttle-loco-select-add").on("vclick", function(event, ui) {
   $("#throttle-loco-select-add-li").hide();
   $("#throttle-loco-list").hide();
   $("#throttle-loco-select-manual").show();
   $("#throttle-loco-select-confirm-li").show();
  });
 } else {
  $("#throttle-loco-list").hide();
  $("#throttle-loco-select-manual").show();
  $("#throttle-loco-select-add-li").hide();
 }
 $("#throttle-loco-select-confirm").on("vclick", function(event, ui) {
   changeLocomotive($("#throttle-loco-select-manual-address").val());
   $("#throttle-loco-select").popup("close");
  });
 $('[id^=funct_]').each(function() {
  var functionID = $(this).prop('id').substr(6);
  var label=functionID;
  if(functionID === '0') {
   label = 'FL';
  }
  $(this).flipswitch({
   offText:label,
   onText:label,
   disabled:true
  });
  $(this).on('change', function(event, ui) {
   if(fireLocoEvents) {
    var selectedLoco = $("#selected-loco-address").val();
    var state = '0';
    if(this.checked) {
     state = '1';
    }
    sendCommand(String.format('<fex {0} {1} {2}>', selectedLoco, functionID, state));
   }
  });
 });
}
function disableLocomotiveInputs() {
 $('[id^=funct_]').flipswitch('disable');
 $('#throttle-direction').flipswitch('disable');
 $('#throttle-speed').slider('disable');
 $('#throttle-release-loco').button('disable');
}
function enableLocomotiveInputs() {
 $('[id^=funct_]').flipswitch('enable');
 $('#throttle-direction').flipswitch('enable');
 $('#throttle-speed').slider('enable');
 $('#throttle-release-loco').button('enable');
}
const CSSections = ["Status", "Turnouts", "Sensors", "Sensors (S88)", "Outputs", "Locomotive Roster", "Programmer", "OTA", "Configuration"];
const CSAutoRefSections = ["Status", "Turnouts", "Sensors", "Sensors (S88)", "Outputs"];
function setupBaseStation() {
 $("#cs-accordion").on("accordionactivate", function(event, ui) {
  var section = $("#cs-accordion").accordion("option", "active");
  BSTabRefresh(CSSections[section]);
 });
 $("#tabs").on("tabsactivate", function(event, ui) {
  if(ui.newTab.text() == "Command Station") {
   var section = $("#cs-accordion").accordion("option", "active");
   BSTabRefresh(CSSections[section]);
   console.log('enabling auto-refresh of CS tabs every 30s');
   bsTabRefreshInterval = setInterval(function() {
    var section = $("#cs-accordion").accordion("option", "active");
    if(CSAutoRefSections[section] !== undefined) {
     BSTabRefresh(CSSections[section]);
    }
   }, 30000);
  } else {
   if(bsTabRefreshInterval !== null) {
    console.log('disabling auto-refresh of CS tabs');
    clearInterval(bsTabRefreshInterval);
    bsTabRefreshInterval = null;
   }
  }
 });
 setupBSStatus();
 setupBSTurnout();
 setupBSSensor();
 setupBSS88Sensors();
 setupBSOutput();
 setupBSRoster();
 setupProgrammer();
 setupConfig();

 $('#cs-ota-upload').on('vclick', function(event, ui) {
  if($('#cs-ota-firmware').val() != '') {
   var data = new FormData($('#cs-ota-form')[0]);
   $.ajax({url: '/update',enctype: 'multipart/form-data',type: 'POST',data: data,cache: false,processData: false,contentType: false,timeout: 120000,
    beforeSend: function() {showSpinner('Firmware upload in progress...');},
    complete: hideSpinner,
    success: function() {showSpinner('Firmware upload Successful! Command Station restarting...', true);},
    error: function(req, status) {showErrorDialog('Firmware update failed: ' + req.responseText);}
   })
  } else {
   alert('Firmware image not provided!');
  }
 });
}
function setupBSStatus() {
}
function setupBSTurnout() {
 // default to dcc addressing only.
 $('#cs-turnout-dialog-save').on('vclick', function(event, ui) {
  if($('#cs-turnout-address').val() < 1 || $('#cs-turnout-address').val() > 2044){
   alert(String.format('{0} is not a valid address for an accessory decoder', $('#cs-turnout-address').val()));
   return;
  }
  console.log('Creating/Updating turnout using address', $('#cs-turnout-address').val(), 'and type', $('#cs-turnout-type').val());
  $.post('/turnouts', {
   'address' : $('#cs-turnout-address').val(),
   'type' : $('#cs-turnout-type').val()
  });
  BSTabRefresh('Turnouts');
 });
 $('#cs-turnout-create').on('vclick', function(event, ui) {
  $('#cs-turnout-address').val(1);
  $('#cs-turnout-type').val(0).change();
  $('#cs-turnout-editor').popup('open', {positionTo:'window'});
 });
 $('#cs-turnout-refresh').on('vclick', function(event, ui) {
  BSTabRefresh('Turnouts');
 });
}
function setupBSSensor() {
 $('#cs-sensor-dialog-save').on('vclick', function(event, ui) {
  $.post('/sensors', {
   'id': $('#cs-sensor-id').val(),
   'pin' : $('#cs-sensor-pin').val(),
   'pullUp' : $('#cs-sensor-pullup').prop('checked')
  });
  BSTabRefresh('Sensors');
 });
 $('#cs-sensor-create').on('vclick', function(event, ui) {
  $('#cs-sensor-id').val($('#cs-table-sensors tbody tr').length + 1);
  $('#cs-sensor-pin').val(1);
  $('#cs-sensor-pullUp').prop('checked', false).flipswitch('refresh');
  $('#cs-sensor-editor').popup('open', {positionTo:'window'});
 });
 $('#cs-sensor-refresh').on('vclick', function(event, ui) {
  BSTabRefresh('Sensors');
 });
}
function setupBSS88Sensors() {
 $('#cs-sensor-s88-dialog-save').on('vclick', function() {
  $.post('/s88sensors', {
   'id': $('#cs-sensor-s88-id').val(),
   'pin' : $('#cs-sensor-s88-pin').val(),
   'count' : $('#cs-sensor-s88-count').val()
  });
  BSTabRefresh('Sensors (S88)');
 });
 $('#cs-sensor-s88-create').on('vclick', function() {
  $('#cs-sensor-s88-id').val($('#cs-table-sensors-s88 tbody tr').length);
  $('#cs-sensor-s88-sensor-id').val(s88SensorIDBase + ($('#cs-sensor-s88-id').val() * 512));
  $('#cs-sensor-s88-pin').val(1);
  $('#cs-sensor-s88-count').val(8);
  $('#cs-sensor-s88-editor').popup('open', {positionTo:'window'});
 });
 $('#cs-sensor-s88-id').on('change', function() {
  $('#cs-sensor-s88-sensor-id').val(s88SensorIDBase + ($('#cs-sensor-s88-id').val() * 512));
 });
 $('#cs-sensor-s88-refresh').on('vclick', function() {
  BSTabRefresh('Sensors (S88)');
 });
}
function setupBSOutput() {
 $('#cs-output-dialog-save').on('vclick', function() {
  console.log('Creating output', $('#cs-output-id').val(), 'with pin',
   $('#cs-output-pin').val(), 'logicInverted:', $('#cs-output-logic').prop('checked'),
   'forceState:', $('#cs-output-startup-state').prop('checked'),
   'defaultState:',$('#cs-output-default-state').prop('checked'));
  $.post('/outputs', {
   'id': $('#cs-output-id').val(),
   'pin' : $('#cs-output-pin').val(),
   'inverted' : $('#cs-output-logic').prop('checked'),
   'forceState' : $('#cs-output-startup-state').prop('checked'),
   'defaultState' : $('#cs-output-default-state').prop('checked')
  });
  BSTabRefresh('Outputs');
 });
 $('#cs-output-create').on('vclick', function() {
  $('#cs-output-id').val($('#cs-table-outputs tbody tr').length + 1);
  $('#cs-output-pin').val(1);
  $('#cs-output-logic').prop('checked', false).flipswitch('refresh');
  $('#cs-output-startup-state').prop('checked', false).flipswitch('refresh');
  $('#cs-output-default-state').prop('checked', false).flipswitch('refresh');
  $('#cs-output-editor').popup('open', {positionTo:'window'});
 });
 $('#cs-output-refresh').on('vclick', function() {
  BSTabRefresh('Outputs');
 });
 $('#cs-output-startup-state').on('change', function() {
  if(this.checked) {
   $('#cs-output-default-state-div').show();
  } else {
   $('#cs-output-default-state-div').hide();
  }
 });
 $('#cs-output-default-state-div').hide();
}
function setupBSRoster() {
 $('#cs-loco-save').on('vclick', function() {
  console.log('Creating roster entry:', $('#cs-loco-addr').val(),
   'name:', $('#cs-loco-name').val(),
   'idle:', $('#cs-loco-idle').prop('checked'),
   'default:',$('#cs-loco-default').prop('checked'));
  $.post('/locomotive/roster', {
   'address': $('#cs-loco-addr').val(),
   'name' : $('#cs-loco-name').val(),
   'idleOnStartup' : $('#cs-loco-idle').prop('checked'),
   'defaultOnThrottles' : $('#cs-loco-default').prop('checked')
  });
  BSTabRefresh('Locomotive Roster');
 });
 $('#cs-loco-create').on('vclick', function() {
  $('#cs-loco-addr').val(1);
  $('#cs-loco-name').val("");
  $('#cs-loco-idle').prop('checked', false).flipswitch('refresh');
  $('#cs-loco-default').prop('checked', true).flipswitch('refresh');
  $('#cs-loco-editor').popup('open', {positionTo:'window'});
 });
 $('#cs-loco-refresh').on('vclick', function() {
  BSTabRefresh('Locomotive Roster');
 });
}
function setupProgrammer() {
 $('#cs-prog-target').on('change', function() {
  if(this.checked) {
   $('#cs-prog-div-addr').show();
  } else {
   $('#cs-prog-div-addr').hide();
  }
 });
 $('#cs-prog-mode').on('change', function() {
  if(this.checked) {
   $('#cs-prog-div-value').hide();
   if($('#cs-prog-action').val() === 'write') {
    $('#cs-prog-div-bit-value').show();
   } else {
    $('#cs-prog-div-bit-value').hide();
   }
   $('#cs-prog-div-bit').show();
  } else {
   if($('#cs-prog-action').val() === 'write') {
    $('#cs-prog-div-value').show();
   }
   $('#cs-prog-div-bit').hide();
  }
 });
 $('#cs-prog-action').on('change', function() {
  if($(this).val() === 'read') {
   $('#cs-prog-target').val(0);
   $('#cs-prog-target').flipswitch('disable');
   $('#cs-prog-div-addr').hide();
   $('#cs-prog-div-value').hide();
  } else if($(this).val() === 'write') {
   $('#cs-prog-target').flipswitch('enable');
   $('#cs-prog-div-value').show();
  }
  if($(this).val() === 'identify') {
   $('#cs-prog-div-create-roster').show();
   $('#cs-prog-div-target').hide();
   $('#cs-prog-div-addr').hide();
   $('#cs-prog-div-cv').hide();
   $('#cs-prog-div-mode').hide();
   $('#cs-prog-div-value').hide();
  } else {
   $('#cs-prog-div-target').show();
   $('#cs-prog-div-cv').show();
   $('#cs-prog-div-mode').show();
   $('#cs-prog-div-create-roster').hide();
  }
 })
 $('#cs-prog-execute').on('vclick', function() {
  $('#cs-prog-result').val('pending...');
  if($('#cs-prog-action').val() === 'read') {
   $.ajax({url: '/programmer',timeout:15000,dataType:'json',
    data: {'pom':'false','cv': $('#cs-prog-cv').val()},
    beforeSend: function() {showSpinner(String.format('Retrieving CV {0}...', $('#cs-prog-cv').val()));},
    complete: hideSpinner,
    success: function(data, status, xhr) {$('#cs-prog-result').val(String.format('CV {0} has value {1}', data['cv'], data['value']));},
    error: function() {$('#cs-prog-result').val(String.format('CV {0} read was not successful', $('#cs-prog-cv').val()));}
   });
  } else if($('#cs-prog-action').val() === 'write') {
   if($('#cs-prog-mode').prop('checked')) {
    $.ajax({method:'POST',url: '/programmer',timeout:15000,dataType:'json',
     data: {'cv':$('#cs-prog-cv').val(),'pom':$('#cs-prog-target').prop('checked'),'address':$('#cs-prog-addr').val(),'bit':$('#cs-prog-cv-bit').val(),'value':$('#cs-prog-cv-bit-value').prop('checked')},
     beforeSend: function() {showSpinner(String.format('Writing CV {0}...', $('#cs-prog-cv').val()));},
     complete: hideSpinner,
     success: function(data, status, xhr) {$('#cs-prog-result').val(String.format('CV {0} bit {1} written successfully', $('#cs-prog-cv').val(), $('#cs-prog-cv-bit').val()));},
     error: function() {$('#cs-prog-result').val(String.format('CV {0} bit {1} was not written successfully', $('#cs-prog-cv').val(), $('#cs-prog-cv-bit').val()));}
    });
   } else {
    $.ajax({method:'POST',url: '/programmer',timeout:15000,dataType:'json',
     data: {'cv':$('#cs-prog-cv').val(),'pom':$('#cs-prog-target').prop('checked'),'address':$('#cs-prog-addr').val(),'value':$('#cs-prog-cv-value').val()},
     beforeSend: function() {showSpinner(String.format('Writing CV {0}...', $('#cs-prog-cv').val()));},
     complete: hideSpinner,
     success: function() {$('#cs-prog-result').val(String.format('CV {0} written successfully', $('#cs-prog-cv').val()));},
     error: function() {$('#cs-prog-result').val(String.format('CV {0} was not written successfully', $('#cs-prog-cv').val()));}
    });
   }
  } else {
   $.ajax({url:'/programmer',timeout:15000,dataType:'json',
    data: {'pom':'false','identify':'true','create':$('#cs-prog-create-roster').prop('checked')},
    beforeSend: function() {showSpinner('Identifying decoder');},
    complete: hideSpinner,
    success: function(data, status, xhr) {if(data.hasOwnProperty('loco')) {$('#cs-prog-result').val(String.format('Identified the decoder as having address {0} ({1}), speed table {2}.\nRoster entry has been created for the {3}',data.address, data.addressMode, data.speedTable, data.loco.type));} else {$('#cs-prog-result').val(String.format('Identified the decoder as having address {0} ({1}), speed table {2}',data.address, data.addressMode, data.speedTable));}},
    error: function() {$('#cs-prog-result').val('Unable to identify the decoder');}
   });
  }
 });
 $('#cs-prog-div-addr').hide();
 $('#cs-prog-div-bit').hide();
 $('#cs-prog-div-create-roster').hide();
}
function pad_hex(str, length) {var hex = new Array(length + 1).join('0') + str;return hex.substr(-length).match(/.{1,2}/g).join('.');}
function csConfigUpdate(data) {
 $('#cs-lcc-node-id').val(pad_hex(data.lcc.id, 12));
 $('#cs-lcc-can').prop('checked', data.lcc.can).flipswitch('refresh');
 $('#cs-lcc-hub').prop('checked', data.hub).flipswitch('refresh');
 $('#cs-lcc-uplink-reconnect').prop('checked', data.uplink.reconnect).flipswitch('refresh');
 $('#cs-lcc-uplink-auto-service').val(data.uplink.auto_service);
 $('#cs-lcc-uplink-manual-host').val(data.uplink.manual_host);
 $('#cs-lcc-uplink-manual-port').val(data.uplink.manual_port);
 $('#cs-lcc-uplink-mode').val(data.uplink.mode).change();
 $('#cs-cdi-ops-short').val(pad_hex(data.hbridges[0].short, 16));
 $('#cs-cdi-ops-short-clear').val(pad_hex(data.hbridges[0].short_clear, 16));
 $('#cs-cdi-ops-shutdown').val(pad_hex(data.hbridges[0].shutdown, 16));
 $('#cs-cdi-ops-shutdown-clear').val(pad_hex(data.hbridges[0].shutdown_clear, 16));
 $('#cs-cdi-prog-short').val(pad_hex(data.hbridges[1].short, 16));
 $('#cs-cdi-prog-short-clear').val(pad_hex(data.hbridges[1].short_clear, 16));
 $('#cs-cdi-prog-shutdown').val(pad_hex(data.hbridges[1].shutdown, 16));
 $('#cs-cdi-prog-shutdown-clear').val(pad_hex(data.hbridges[1].shutdown_clear, 16));
 $('#cs-wifi-sta-div').hide();
 $('#cs-wifi-connect').hide();
 $("#cs-wifi-mode").val(data.wifi.mode).change();
 if(data.wifi.mode !== 'softap') {
  $('#cs-wifi-sta-div').show();
  $('#cs-wifi-connect').show();
  $('#cs-wifi-ssid').val(data.wifi.station.ssid);
  $('#cs-wifi-ip-mode').prop('checked', data.wifi.station.mode === 'static').flipswitch('refresh');
  if(data.wifi.station.mode === 'static') {
   $('#cs-wifi-static-div').show();
   $('#cs-wifi-sta-ip').val(data.wifi.station.ip);
   $('#cs-wifi-sta-gateway').val(data.wifi.station.gateway);
   $('#cs-wifi-sta-netmask').val(data.wifi.station.netmask);
   $('#cs-wifi-sta-dns').val(data.wifi.dns);
  }
 } else {
  $('#cs-wifi-stat-div').hide();
 }
}
function refreshSSIDList() {
 $('#ssid-connect-confirm').hide();
 $('#ssid-manual-entry').hide();
 $('#ssid-connect-rescan').show();
 refreshTable({table: '#ssid-list', url: '/config?scan=true',
 fields: ['ssid','rssi',
  function(record) {var values=['None','WEP','WPA','WPA2','WPA/WPA2','WPA2 Enterprise'];if(record.auth > 5) {return 'Unknown';}return values[record.auth];},
  function(record) {return createButton({type:'gear', id:String.format("cs-ssid-{0}-{1}", record.ssid, record.auth), title:'Connect'});}
  ],
  refreshCallback:function() {
   $('#ssid-list tr td [id^=cs-ssid-]').button();
   $('#ssid-list tr td [id^=cs-ssid-]').on('vclick', function(event, ui) {
    var idParts = $(this).attr('id').split('-');
    if(idParts[3] !== 0) {
     $('#ssid-manual-ssid').val(idParts[2]);
     $('#ssid-manual-password').val('');
     $('#ssid-list').hide();
     $('#ssid-manual-entry').show();
     $('#ssid-connect-manual').hide();
     $('#ssid-connect-confirm').show();
     $('#ssid-connect-rescan').hide();
     $('#ssid-connect').popup('reposition', {positionTo:'window'});
    } else {
     $('#ssid-connect').popup('close');
     $.ajax({method: 'POST',
      url:String.format('/config?ssid={0}&pass={1}', idParts[3], $('#ssid-manual-password').val()),
      beforeSend: function() {showSpinner('Saving Configuration...');},
      complete: hideSpinner,
      success : function (data, status, xhr) {if(!data.hasOwnProperty('restart')) {csConfigUpdate(data);} else {showSpinner(data.state, true);}},
      error : function(xhr, status, error) {showErrorDialog("The command station reported a failure saving configuration data", error);}
     });
    }
   });
   $('#ssid-list').show();
   $('#ssid-connect').popup('reposition', {positionTo:'window'});
  }
 })
}
function setupConfig() {
 $("#cs-config-tabs").on("tabsactivate", function(event, ui) {
  if(ui.newTab.text() === "WiFi") {
   $('#cs-wifi-connect').show();
  } else {
   $('#cs-wifi-connect').hide();
  }
 });
 $('#cs-factory-reset').on("vclick", function() {
  $.ajax({url: '/config?reset',method: 'POST',beforeSend: function() {showSpinner('Initiating Factory Reset...', true);},});
 });
 $("#cs-save-config").on("vclick", function() {
  var tablist = ["WiFi", "LCC", "Uplink", "OPS", "PROG"];
  var section = $("#cs-config-tabs").tabs("option", "active");
  var url = "";
  if (tablist[section] == "WiFi") {
   url = String.format("/config?mode={0}", $('#cs-wifi-mode').val());
  } else if (tablist[section] == "LCC") {
   url = String.format("/config?nodeid={0}&lcc-hub={1}&lcc-can={2}", $('#cs-lcc-node-id').val(), $('#cs-lcc-hub').prop('checked'), $('#cs-lcc-can').prop('checked'));
  } else if (tablist[section] == "Uplink") {
   url = String.format("/config?uplink-mode={0}&uplink-service={1}&uplink-manual={2}&uplink-manual-port={3}&uplink-reconnect={4}", $('#cs-lcc-uplink-mode').val(), $('#cs-lcc-uplink-auto-service').val(), $('#cs-lcc-uplink-manual-host').val(), $('#cs-lcc-uplink-manual-port').val(), $('#cs-lcc-uplink-reconnect').val());
  } else if (tablist[section] == "OPS") {
   url = String.format("/config?ops-short={0}&ops-short-clear={1}&ops-shutdown={2}&ops-shutdown-clear={3}", $('#cs-cdi-ops-short').val(), $('#cs-cdi-ops-short-clear').val(), $('#cs-cdi-ops-shutdown').val(), $('#cs-cdi-ops-shutdown-clear').val());
  } else if (tablist[section] == "PROG") {
   url = String.format("/config?prog-short={0}&prog-short-clear={1}&prog-shutdown={2}&prog-shutdown-clear={3}", $('#cs-cdi-prog-short').val(), $('#cs-cdi-prog-short-clear').val(), $('#cs-cdi-prog-shutdown').val(), $('#cs-cdi-prog-shutdown-clear').val());
  } else {
   console.log('Unknown configuration tab:', section, ', ignoring');
   return;
  }
  $.ajax({method: 'POST',url: url,
   beforeSend: function() {showSpinner(String.format('Saving {0} config...', tablist[section]));},
   complete: hideSpinner,
   success : function (data, status, xhr) {if(!data.hasOwnProperty('restart')) {csConfigUpdate(data);} else {showSpinner(data.restart, true);}},
   error : function(xhr, status, error) {showErrorDialog("The command station reported a failure saving configuration data", error);}
  });
 });
 $('#cs-wifi-mode').on('change', function() {
  if($("#cs-wifi-mode").val() === 'station' || $("#cs-wifi-mode").val() === 'softap-station') {
   $('#cs-wifi-sta-div').show();
   $('#cs-wifi-connect').show();
  } else {
   $('#cs-wifi-sta-div').hide();
   $('#cs-wifi-connect').hide();
  }
 });
 $('#cs-wifi-ip-mode').on('change', function() {
  if(this.checked) {
   $("#cs-wifi-static-div").show();
  } else {
   $("#cs-wifi-static-div").hide();
  }
 });
 $("#cs-wifi-static-div").hide();
 $('#cs-wifi-station-div').hide();
 $('#ssid-connect-confirm').hide();
 $('#cs-wifi-connect').on('vclick', function() {
  $('#ssid-connect-rescan').show();
  $('#ssid-manual-entry').hide();
  $('#ssid-list tbody').empty();
  $('#ssid-connect').popup('open', {positionTo:'window'});
  refreshSSIDList();
 });
 $('#ssid-connect-manual').on('vclick', function() {
  $('#ssid-manual-ssid').val('');
  $('#ssid-manual-password').val('');
  $('#ssid-list').hide();
  $('#ssid-manual-entry').show();
  $('#ssid-connect-confirm').show();
  $('#ssid-connect-rescan').hide();
 })
 $('#ssid-connect-rescan').on('vclick', function() {
  refreshSSIDList();
 })
 $('#ssid-connect-confirm').on('vclick', function() {
  $('#ssid-connect').popup('close');
  $.ajax({method:'POST', url:String.format('/config?ssid={0}&password={1}', $('#ssid-manual-ssid').val(), $('#ssid-manual-password').val())});
 })
}
function BSTabRefresh(section) {
 console.log("refreshing: " + section);
 if(section === 'Status') {
  refreshTable({table: '#cs-table-power', url: '/power',
   fields: ['name', 'state', 'usage', function(record) {
    if(record.prog) {
     return '';
    } else if(record.state === 'Off') {
     return createButton({type:'power', id:String.format("cs-power-{0}-true", record.name), title:'Enable'});
    } else {
     return createButton({type:'power', id:String.format("cs-power-{0}-false", record.name), title:'Disable'});
    }
   }],
   refreshCallback:function() {
    $('#cs-table-power tr td [id^=cs-power-]').button();
    $('#cs-table-power tr td [id^=cs-power-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     $.ajax({method:'PUT',url:String.format('/power?name={0}&state={1}',idParts[2],idParts[3]),
      dataType:'text',
      complete:function(){BSTabRefresh('Status');}});
    });
   }
  });
  refreshTable({table: '#cs-table-locomotives', url: '/locomotive',
   fields: ['address', 'speed', 'dir', function(record) {
    var buttons = '';
    buttons += createButton({type:'delete', id:String.format("loco-{0}-delete", record.address)});
    buttons += createButton({type:'stop', id:String.format("loco-{0}-stop", record.address)});
    return buttons;
   }],
   refreshCallback: function() {
    $('#cs-table-locomotives tr td [id^=loco-]').button();
    $('#cs-table-locomotives tr td [id^=loco-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     if(idParts[2] === 'delete') {
      $.ajax({method:'DELETE',url:String.format('/locomotive?address={0}',idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Deleting locomotive {0}",idParts[1]));},
       complete:function(){hideSpinner();BSTabRefresh('Status');}});
     } else if(idParts[2] === 'stop') {
      sendCommand(String.format('<tex {0} 0 -1>', idParts[1]));
      BSTabRefresh('Status');
     }
    });
   }
  });
 } else if(section === 'Turnouts') {
  refreshTable({table: '#cs-table-turnouts', url: '/turnouts',
   fields: ['address',
    function(record) { // convert type
     var typeStrings = ["Left", "Right", "Wye", "Multi"];
     return typeStrings[record.type];
    }, 'state', function(record) {
    var buttons = '';
    buttons += createButton({type:'delete', id:String.format("turnout-{0}-delete", record.address)});
    buttons += createButton({type:'edit', id:String.format("turnout-{0}-edit", record.address)});
    if(record.state) {
     buttons += createButton({type:'action', id:String.format("turnout-{0}-throw", record.address), title:'Throw'});
    } else {
     buttons += createButton({type:'action', id:String.format("turnout-{0}-close", record.address), title:'Close'});
    }
    return buttons;
   }],
   refreshCallback: function() {
    $('#cs-table-turnouts tr td [id^=turnout-]').button();
    $('#cs-table-turnouts tr td [id^=turnout-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     if(idParts[2] === 'delete') {
      $.ajax({method:'DELETE',url:String.format('/turnouts?address={0}',idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Deleting Turnout {0}",idParts[1]));},
       complete:function() {hideSpinner();BSTabRefresh('Turnouts');}});
     } else if(idParts[2] === 'edit') {
      $.ajax({url: String.format('/turnouts?address={0}', idParts[1]),
       success:function(data, status, jqxhr) {
        console.log('Edit turnout', data);
        $('#cs-turnout-address').val(data.address);
        $('#cs-turnout-type').val(data.type).change();
        $('#cs-turnout-editor').popup('open', {positionTo:'window'});
       },
       error:function(req, status) {showErrorDialog(String.format('Unable to edit turnout {0}', idParts[1]), status);}
      });
     } else {
      $.ajax({method:'PUT',url:String.format('/turnouts?address={0}',idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Toggling Turnout {0}",idParts[1]));},
       complete:function() {hideSpinner();BSTabRefresh('Turnouts');}});
     }
    });
   }
  });
 } else if(section === 'Sensors') {
  refreshTable({table: '#cs-table-sensors', url: '/sensors',
   fields: ['id', 'pin', 'pullUp', 'state', function(record) {
    var buttons = '';
    if(record.pin > 0) {
     buttons += createButton({type:'delete', id:String.format("sensor-{0}-delete", record.id)});
     buttons += createButton({type:'edit', id:String.format("sensor-{0}-edit", record.id)});
    }
    return buttons;
   }],
   refreshCallback: function() {
    $('#cs-table-sensors tr td [id^=sensor-]').button();
    $('#cs-table-sensors tr td [id^=sensor-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     if(idParts[2] === 'delete') {
      $.ajax({method:'DELETE',url:String.format('/sensors?id={0}',idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Deleting Sensor {0}",idParts[1]));},
       complete:function() {hideSpinner();BSTabRefresh('Sensors');}});
     } else if(idParts[2] === 'edit') {
      $.ajax({url:String.format('/sensors?id={0}',idParts[1]),
       success:function(data, status, jqxhr) {
        console.log('Edit sensor', data);
        $('#cs-sensor-id').val(data.id);
        $('#cs-sensor-pin').val(data.pin);
        $('#cs-sensor-pullUp').prop('checked', data.pullUp).flipswitch('refresh');
        $('#cs-sensor-editor').popup('open', {positionTo:'window'});
       },
       error:function(req, status) {showErrorDialog(String.format('Unable to edit sensor {0}', idParts[1]), status);}
      });
     }
    });
   }
  });
 } else if(section === 'Sensors (S88)') {
  refreshTable({table: '#cs-table-sensors-s88', url: '/s88sensors',
   fields: ['id', 'pin', 'sensorIDBase', 'count', function(record) {
    var state = '';
    var dataSplit = record.state.split("");
    var count = 0;
    for(index in dataSplit) {
     count++;
     if(dataSplit[index] === '0') {
      state += "<span class='s88SensorOff'>OFF</span>&nbsp;";
     } else {
      state += "<span class='s88SensorOn'>ON&nbsp;</span>&nbsp;";
     }
     if(count % 8 === 0) {
      state += "<br/>";
     }
    }
    return state;
   }, function(record) {
    var buttons = '';
    buttons += createButton({type:'delete', id:String.format("s88sensor-{0}-delete", record.id)});
    buttons += createButton({type:'edit', id:String.format("s88sensor-{0}-edit", record.id)});
    return buttons;
   }],
   refreshCallback: function() {
    $('#cs-table-sensors-s88 tr td [id^=s88sensor-]').button();
    $('#cs-table-sensors-s88 tr td [id^=s88sensor-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     if(idParts[2] === 'delete') {
      $.ajax({method:'DELETE',url:String.format('/s88sensors?id={0}',idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Deleting S88 Bus {0}",idParts[1]));},
       complete:function(){hideSpinner();BSTabRefresh('Sensors (S88)');}});
     } else if(idParts[2] === 'edit') {
      $.ajax({url: String.format('/s88sensors?id={0}', idParts[1]),
       success:function(data, status, jqxhr) {
        console.log('Edit s88 sensor', data);
        $('#cs-sensor-s88-id').val(data.id);
        $('#cs-sensor-s88-sensor-id').val(s88SensorIDBase + (data.id * 512));
        $('#cs-sensor-s88-pin').val(data.dataPin);
        $('#cs-sensor-s88-count').val(data.count);
        $('#cs-sensor-s88-editor').popup('open', {positionTo:'window'});
       },
       error:function(req, status) {showErrorDialog(String.format('Unable to edit sensor {0}', idParts[1]), status);}
      });
     }
    });
   }
  });
 } else if(section === 'Outputs') {
  refreshTable({table: '#cs-table-outputs', url: '/outputs',
   fields: ['id', 'pin', 'flags', 'state', function(record) {
    var buttons = '';
    buttons += createButton({type:'delete', id:String.format("output-{0}-delete", record.id)});
    buttons += createButton({type:'edit', id:String.format("output-{0}-edit", record.id)});
    if(record.state === 'Off') {
     buttons += createButton({type:'power', id:String.format("output-{0}-toggle", record.id), title:'Enable'});
    } else {
     buttons += createButton({type:'power', id:String.format("output-{0}-toggle", record.id), title:'Disable'});
    }
    return buttons;
   }],
   refreshCallback: function() {
    $('#cs-table-outputs tr td [id^=output-]').button();
    $('#cs-table-outputs tr td [id^=output-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     if(idParts[2] === 'delete') {
      $.ajax({method: 'DELETE',url: String.format('/outputs?id={0}', idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Deleting Output {0}", idParts[1]));},
       complete:function(){hideSpinner();BSTabRefresh('Outputs');}});
     } else if(idParts[2] === 'edit') {
      $.ajax({url: String.format('/outputs?id={0}', idParts[1]),
       success:function(data, status, jqxhr) {
        console.log('Edit output', data);
        $('#cs-output-id').val(data.id);
        $('#cs-output-pin').val(data.pin);
        $('#cs-output-logic').prop('checked', data.flags.includes('activeLow')).flipswitch('refresh');
        $('#cs-output-startup-state').prop('checked', data.flags.includes('force')).flipswitch('refresh');
        $('#cs-output-default-state').prop('checked', data.flags.includes('force(on)')).flipswitch('refresh');
        $('#cs-output-editor').popup('open', {positionTo:'window'});
       },
       error:function(req, status) {showErrorDialog(String.format('Unable to edit output {0}', idParts[1]), status);}
      });
     } else {
      sendCommand(String.format('<Zex {0}>', idParts[1]));
      BSTabRefresh('Outputs');
     }
    });
   }
  });
 } else if(section === 'Locomotive Roster') {
  refreshTable({table: '#cs-table-loco-roster', url: '/locomotive/roster',
   fields: ['address', 'name', function(record) {
    var buttons = '';
    buttons += createButton({type:'delete', id:String.format("roster-{0}-delete", record.address)});
    buttons += createButton({type:'edit', id:String.format("roster-{0}-edit", record.address)});
    if(record.idleOnStartup === true) {
     buttons += createButton({type:'power', id:String.format("roster-{0}-idle-off", record.address), title:'Disable Idle'});
    } else {
     buttons += createButton({type:'power', id:String.format("roster-{0}-idle-on", record.address), title:'Enable Idle'});
    }
    if(record.defaultOnThrottles === true) {
     buttons += createButton({type:'action', id:String.format("roster-{0}-default-off", record.address), title:'Disable default on Throttles'});
    } else {
     buttons += createButton({type:'action', id:String.format("roster-{0}-default-on", record.address), title:'Enable default on Throttles'});
    }
    return buttons;
   }],
   refreshCallback: function() {
    $('#cs-table-loco-roster tr td [id^=roster-]').button();
    $('#cs-table-loco-roster tr td [id^=roster-]').on('vclick', function(event, ui) {
     var idParts = $(this).attr('id').split('-');
     if(idParts[2] === 'delete') {
      $.ajax({method: 'DELETE',url: String.format('/locomotive/roster?address={0}', idParts[1]),
       dataType:'text',
       beforeSend:function(){showSpinner(String.format("Deleting locomotive {0}", idParts[1]));},
       complete:function(){hideSpinner();BSTabRefresh('Locomotive Roster');}});
     } else if(idParts[2] === 'edit') {
      $.ajax({url: String.format('/locomotive/roster?address={0}', idParts[1]),
       success:function(data, status, jqxhr) {
        console.log('Edit roster entry', data);
        $('#cs-loco-addr').val(data.address);
        $('#cs-loco-name').val(data.name);
        $('#cs-loco-idle').prop('checked', data.idleOnStartup).flipswitch('refresh');
        $('#cs-loco-default').prop('checked', data.defaultOnThrottles).flipswitch('refresh');
        $('#cs-loco-editor').popup('open', {positionTo:'window'});
       },
       error:function(req, status) {showErrorDialog(String.format('Unable to edit roster entry {0}', idParts[1]), status);}
      });
     } else if(idParts[2] === 'idle') {
      $.ajax({method: 'PUT',url: String.format('/locomotive/roster?address={0}&idleOnStartup={1}', idParts[1], idParts[3] === 'on'),
       success:function() {BSTabRefresh('Locomotive Roster');},
       error: function(req, status) {showErrorDialog(String.format('Failed to update loco {0}', idPArts[1]), status);}
      });
     } else if(idParts[2] === 'default') {
      $.ajax({method: 'PUT',url: String.format('/locomotive/roster?address={0}&defaultOnThrottles={1}', idParts[1], idParts[3] === 'on'),
       dataType:'text',
       success:function() {BSTabRefresh('Locomotive Roster');},
       error: function(req, status){showErrorDialog(String.format('Failed to update loco {0}', idPArts[1]), status);}
      });
     }
    });
   }
  });
 } else if(section === 'Configuration') {
  $.ajax({url: '/config',timeout: 5000,
   beforeSend: function() {showSpinner('Loading Configuration...');},
   complete: hideSpinner,
   success : function (data, status, xhr) {csConfigUpdate(data);},
   error : function(xhr, status, error) {showErrorDialog('The command station reported a failure retrieving configuration data', error);}
  });
 }
}
function changeLocomotive(newAddress) {
 if(newAddress !== "") {
  console.log("selected loco:", newAddress);
  $.ajax({url: '/locomotive?address=' + newAddress,
   beforeSend:function(){showSpinner(String.format("Loading locomotive {0}", newAddress));},
   complete:hideSpinner,
   success:function(data, status, xhr){
    console.log(data);
    fireLocoEvents = false;
    $("#selected-loco-address").val(newAddress);
    $("#throttle-speed").val(data.speed).slider("refresh");
    $("#throttle-direction").prop("checked", data.dir === 'REV').flipswitch("refresh");
    $.each(data.functions, function(index, item) {
     $(String.format("#funct_{0}", item.id)).prop('checked', item.state).flipswitch("refresh");
    });
    enableLocomotiveInputs();
    fireLocoEvents = true;
    enableTrackPower();
   },
   error:function(xhr, status, error) {showErrorDialog(String.format('Unable to acquire locomotive: {0}', newAddress), error);}
  });
 }
}
function refreshTable({table, url, fields, filter=function() {return true;}, failureHandler=function(xhr, status) {showErrorDialog(String.format('Failed to load url:{0}', url), status);}, refreshCallback=function() {}} = {}) {
 console.log('refreshing table:', table, 'using url:', url, 'and fields:', fields)
 $.ajax({url: url, dataType:'json',error: failureHandler, complete: hideSpinner,
  beforeSend:function(){showSpinner('Refreshing data');$(table + ' tbody').empty();},
  success:function(data, status, jqxhr) {
   var tableBody = $(table + ' tbody');
   $.each(data, function(id, record) {
    if (filter(record)) {
     var row = '<tr>';
     $.each(fields, function(id, field) {
      row += '<td>';
      if(typeof field === 'string') {
       row += record[field];
      } else {
       row += field(record);
      }
      row += '</td>';
     })
     tableBody.append(row);
    }
   });
   $(table).table('refresh');
   refreshCallback();
  }
 });
}
 </script>
</body>
</html>